{{ $values := .Values }}
{{ $ns     := .Release.Namespace }}
{{ if .Values.container_rules.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ .Release.Name }}-container-rules
  annotations:
    nextdoor.com/chart: {{ .Values.chart_name }}
    nextdoor.com/source: {{ .Values.chart_source }}
spec:
  groups:
  - name: container_rules
    rules:
    {{ with .Values.container_rules.pod_container_terminated -}}
    - alert: pod_container_terminated
      annotations:
        description: {{`Pod {{$labels.pod}} in namespace {{$labels.namespace}} has a container terminated for more than 10 minutes`}}
        summary: {{`Pod {{$labels.pod}} in namespace {{$labels.namespace}} in error status`}}
        runbook_url: {{ $values.runbook_url }}#kube-pod-container-terminated
      expr: 'kube_pod_container_status_terminated_reason{reason=~"OOMKilled|Error|ContainerCannotRun", namespace="{{ $ns }}"} > 0'
      expr: 'kube_pod_container_status_terminated_reason{reason=~"{{ join "|" .reasons }}", namespace="{{ $ns }}"} > {{ .threshold }}'
      for: {{ .for }}
      labels:
        severity: {{ .severity }}
    {{ end -}}
{{ end -}}
